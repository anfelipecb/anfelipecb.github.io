{%- assign img_path = include.path | remove: ".jpg" | remove: ".jpeg" | remove: ".png" | remove: ".tiff" -%}
{%- assign file_ext = include.path | split: "." | last | downcase -%}

<figure>
  {%- if file_ext == "webm" or file_ext == "mp4" or file_ext == "gif" -%}
    <!-- Video/Animated content -->
    <video 
      {% if include.class %}class="{{ include.class }}"{% endif %}
      autoplay 
      loop 
      muted 
      playsinline
      {% if include.width %}width="{{ include.width }}"{% endif %}
      {% if include.height %}height="{{ include.height }}"{% endif %}
      style="width: 100%; height: auto;"
    >
      {%- if file_ext == "gif" -%}
        <!-- Try webm first if available, fallback to gif -->
        {%- assign webm_path = include.path | replace: ".gif", ".webm" -%}
        <source src="{{ webm_path | relative_url }}" type="video/webm">
      {%- endif %}
      <source src="{% if include.cache_bust %}{{ include.path | relative_url | bust_file_cache }}{% else %}{{ include.path | relative_url }}{% endif %}" 
              type="{% if file_ext == 'webm' %}video/webm{% elsif file_ext == 'mp4' %}video/mp4{% else %}image/gif{% endif %}">
      <!-- Fallback image if video not supported -->
      <img
        src="{% if include.cache_bust %}{{ include.path | relative_url | bust_file_cache }}{% else %}{{ include.path | relative_url }}{% endif %}"
        {% if include.alt %}alt="{{ include.alt }}"{% endif %}
        style="width: 100%; height: auto;"
      />
    </video>
  {%- else -%}
    <!-- Static image -->
    <picture>
      {% if site.imagemagick.enabled %}
      {% for i in site.imagemagick.widths -%}
        <source
          class="responsive-img-srcset"
          media="(max-width: {{ i }}px)"
          srcset="{{ img_path | relative_url }}-{{ i }}.webp"
        />
      {% endfor -%}
      {% endif %}

      <!-- Fallback to the original file -->
      <img
        src="{% if include.cache_bust %}{{ include.path | relative_url | bust_file_cache }}{% else %}{{ include.path | relative_url }}{% endif %}"
        {% if include.class %}class="{{ include.class }}"{% endif %}
        {% if include.width %}width="{{ include.width }}"{% else %}width="auto"{% endif %}
        {% if include.height %}height="{{ include.height }}"{% else %}height="auto"{% endif %}
        {% if include.min-width %}min-width="{{ include.min-width }}"{% endif %}
        {% if include.min-height %}min-height="{{ include.min-height }}"{% endif %}
        {% if include.max-width %}max-width="{{ include.max-width }}"{% endif %}
        {% if include.max-height %}max-height="{{ include.max-height }}"{% endif %}
        {% if include.alt %}alt="{{ include.alt }}"{% endif %}
        {% if include.title %}title="{{ include.title }}"{% endif %}
        {% if include.zoomable %}data-zoomable{% endif %}
        onerror="this.onerror=null; $('.responsive-img-srcset').remove();"
      />
    </picture>
  {%- endif -%}

  {%- if include.caption -%}<figcaption class="caption">{{ include.caption }}</figcaption>{%- endif %}

</figure>
